<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>使用pgpool&#43;流复制搭建Postgresql高可用环境</title>
<meta name="description" content=" Sung Yung&#39;s Personal blog about everything">
<meta name="generator" content="Hugo 0.19" />
<meta property="og:title" content="使用pgpool&#43;流复制搭建Postgresql高可用环境" />
<meta property="og:description" content="研究了2周的pgpool搭建终于有点了成果，在这里总结下整个过程。

一.环境

db1 10.0.0.2  ubuntu 14.04 server

db2 10.0.0.3  ubuntu 14.04 server

watchdog VIP： 10.0.0.4

pg版本：    9.4.0

pgpool版本：3.4.1

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/pgpool/" />



<meta property="article:published_time" content="2015-05-10T19:18:40&#43;08:00"/>
<meta property="article:modified_time" content="2015-05-10T19:18:40&#43;08:00"/>











<link rel="dns-prefetch" href="//fonts.googleapis.com" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700" type="text/css" media="all" />
<link rel="stylesheet" href="/css/style.css" type="text/css" media="all" />
<script type="text/javascript" src="/js/scripts.js"></script>
</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="container container-outer">
		<header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
			<div class="container container-inner clearfix">
				<div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
					<a class="logo__link" href="/" title="Sung Yung" rel="home">
						<h1 class="logo__title">Sung Yung</h1>
						<h2 class="logo__tagline">人生苦短，我爱Python</h2>
					</a>
				</div>
			</div>
			<nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<ul class="menu__list">
	</ul>
</nav>
		</header>
		<div class="wrapper clearfix">

<div class="main-content content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="post__header clearfix">
			<h1 class="post__title">使用pgpool&#43;流复制搭建Postgresql高可用环境</h1>
			<p class="post__meta meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
				<time class="post__meta-date" datetime="2015-05-10 19:18:40 &#43;0800 CST">May 10, 2015</time>
				<span class="post__meta-categories meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
					<a class="meta-categories__link" href="/categories/%e5%85%b6%e4%bb%96" rel="category">其他</a></span>
			</p>
		</header>
		<div class="post__content clearfix">
			<p>研究了2周的pgpool搭建终于有点了成果，在这里总结下整个过程。</p>

<h2 id="一-环境">一.环境</h2>

<p>db1 10.0.0.2  ubuntu 14.04 server</p>

<p>db2 10.0.0.3  ubuntu 14.04 server</p>

<p>watchdog VIP： 10.0.0.4</p>

<p>pg版本：    9.4.0</p>

<p>pgpool版本：3.4.1</p>

<p></p>

<pre><code class="language-sh"># 创建postgres用户，并创建用于安装pg的目录
root@ubuntu:~# groupadd postgres
root@ubuntu:~# useradd -g postgres -d /home/postgres -m -s /bin/bash postgres
root@ubuntu:~# passwd postgres
root@ubuntu:~# su - postgres
postgres@ubuntu:~ mkdir -p /home/postgres/db/data
</code></pre>

<p>修改两个节点的hosts文件，设置postgres用户之间无密码连接，使用ssh-keygen和ssh-copy-id两个命令。</p>

<p>依赖包，源码在两个节点上都需要安装。</p>

<h2 id="二-依赖包的安装">二.依赖包的安装</h2>

<pre><code class="language-sh"># 编译postgresql源码需要zlib1g-dev libreadline-dev flex bison make
root@ubuntu:~# apt-get install --yes --force-yes zlib1g-dev libreadline-dev flex bison make

# pgpool watchdog需要arping
root@ubuntu:~# apt-get install --yes --force-yes arping
</code></pre>

<h2 id="三-源码安装">三.源码安装</h2>

<pre><code class="language-sh"># 编译pg源码并安装
root@ubuntu:~# tar xvf postgresql-9.4.0.tar.bz2 -C /tmp
root@ubuntu:~# cd /tmp/postgresql-9.4.0
root@ubuntu:/tmp/postgresql-9.4.0~# ./configure --prefix &amp;&amp; make &amp;&amp; make install

# 将pg加入环境变量
root@ubuntu:~# sed -i '1i\PATH=\$PATH:/home/postgres/db/bin \nexport PGDATA=/home/postgres/db/data' /home/postgres/.bashrc
root@ubuntu:~# sed -i '1i\PATH=\$PATH:/home/postgres/db/bin \nexport PGDATA=/home/postgres/db/data' /root/.bashrc
root@ubuntu:~# source ~/.bashrc

# 编译pgpool源码并安装
root@ubuntu:~# tar xvf pgpool-II-3.4.1.tar.gz -C /tmp
root@ubuntu:~# cd /tmp/pgpool-II-3.4.1
root@ubuntu:/tmp/pgpool-II-3.4.1~# ./configure --prefix &amp;&amp; make &amp;&amp; make install
# 安装pgpool-recovery，用于在线恢复
# pg9.4版本中已经含有pgpool-regclass，所以这里不用安装
root@ubuntu:/tmp/pgpool-II-3.4.1~# cd src/sql/pgpool-recovery &amp;&amp; make install
</code></pre>

<p>拷贝pcp.conf，pgpool.conf和pool_hba.conf，默认在/usr/local/etc下</p>

<p>创建/var/run/pgpool，/var/log/pgpool，修改目录权限</p>

<pre><code>root@ubuntu:~# mkdir /var/run/pgpool /var/log/pgpool
root@ubuntu:~# chown -R postgres:postgres /var/run/pgpool /var/log/pgpool /usr/local/etc
</code></pre>

<p>在/home/postgres/db/bin下添加failover_stream.sh脚本（注意执行权限），该脚本用于
故障切换。</p>

<p>failover_stream.sh</p>

<pre><code class="language-sh">#!/usr/bin/env bash
# Execute command by failover.
# special values:
# 特殊字符	描述
# %d	断开连接的节点的后台 ID。
# %h	断开连接的节点的主机名。
# %p	断开连接的节点的端口号。
# %D	断开连接的节点的数据库实例所在目录。
# %M	旧的主节点 ID。
# %m	新的主节点 ID。
# %H	新的主节点主机名。
# %P	旧的第一节点 ID。
# %r    新的主节点端口
# %R    新的主节点数据库实例目录
# %%	'%' 字符

# ---------------------------------------------------------------------
# prepare
# ---------------------------------------------------------------------

SCRIPT_LOG=&quot;/var/log/pgpool/failover.log&quot;

FAILED_NODE_ID=${1}
FAILED_NODE_HOST=${2}
FAILED_NODE_PORT=${3}
FAILED_NODE_PGDATA=${4}
NEW_MASTER_NODE_ID=${5}
OLD_MASTER_NODE_ID=${6}
NEW_MASTER_NODE_HOST=${7}
OLD_PRIMARY_NODE_ID=${8}
NEW_MASTER_NODE_PORT=${9}
NEW_MASTER_NODE_PGDATA=${10}

echo &quot;----------------------------------------------------------------------&quot; &gt;&gt; ${SCRIPT_LOG}
date &gt;&gt; ${SCRIPT_LOG}
echo &quot;----------------------------------------------------------------------&quot; &gt;&gt; ${SCRIPT_LOG}
echo &quot;&quot; &gt;&gt; ${SCRIPT_LOG}

echo &quot;
[ node which failed ]
FAILED_NODE_ID           ${FAILED_NODE_ID}
FAILED_NODE_HOST         ${FAILED_NODE_HOST}
FAILED_NODE_PORT         ${FAILED_NODE_PORT}
FAILED_NODE_PGDATA       ${FAILED_NODE_PGDATA}

[ before failover ]
OLD_PRIMARY_NODE_ID      ${OLD_PRIMARY_NODE_ID}
OLD_MASTER_NODE_ID       ${OLD_MASTER_NODE_ID}

[ after faiover ]
NEW_MASTER_NODE_ID       ${NEW_MASTER_NODE_ID}
NEW_MASTER_NODE_HOST     ${NEW_MASTER_NODE_HOST}
NEW_MASTER_NODE_PORT     ${NEW_MASTER_NODE_PORT}
NEW_MASTER_NODE_PGDATA   ${NEW_MASTER_NODE_PGDATA}
&quot; &gt;&gt; ${SCRIPT_LOG}

# ---------------------------------------------------------------------
# Do promote only when the primary node failes
# ---------------------------------------------------------------------

if [ &quot;${FAILED_NODE_ID}&quot; == &quot;${OLD_PRIMARY_NODE_ID}&quot; ]; then
    PROMOTE_COMMAND=&quot;pg_ctl -D ${NEW_MASTER_NODE_PGDATA} promote&quot;

    echo &quot;The primary node (node ${OLD_PRIMARY_NODE_ID}) dies.&quot; &gt;&gt; ${SCRIPT_LOG}
    echo &quot;Node ${NEW_MASTER_NODE_ID} takes over the primary.&quot; &gt;&gt; ${SCRIPT_LOG}

    echo &quot;Execute: ${PROMOTE_COMMAND}&quot; &gt;&gt; ${SCRIPT_LOG}
    ssh postgres@${NEW_MASTER_NODE_HOST} -T &quot;${PROMOTE_COMMAND}&quot; &gt;&gt; ${SCRIPT_LOG}

else
    echo &quot;Node ${FAILED_NODE_ID} dies, but it's not the primary node. This script doesn't anything.&quot; &gt;&gt; ${SCRIPT_LOG}
fi

echo &quot;&quot; &gt;&gt; ${SCRIPT_LOG}

</code></pre>

<p>在/home/postgres/db/data下添加basebackup.sh和pgpool_remote_start，用于在线恢复。</p>

<p>basebackup.sh，db1上$host修改成db1，db2上同理。</p>

<pre><code class="language-sh">#!/usr/bin/env bash
# Recovery script for streaming replication.
# This script assumes that DB node 0 is primary, and 1 is standby.
#
datadir=$1
desthost=$2
destdir=$3

psql -c &quot;SELECT pg_start_backup('Streaming Replication', true)&quot; postgres

ssh -T postgres@$desthost mv $destdir/basebackup.sh $destdir/../
ssh -T postgres@$desthost rm -rf $destdir/*
ssh -T postgres@$desthost pg_basebackup -D $destdir -Fp -Xs -v -P -h $host -U repl
ssh -T postgres@$desthost mv $destdir/../basebackup.sh $destdir/

ssh -T postgres@$desthost mv $destdir/recovery.done $destdir/recovery.conf
ssh -T postgres@$desthost &quot;sed -i \&quot;s/[# ]*primary_conninfo[ ]*=.*/primary_conninfo = 'host=$host port=5432 user=$PG_REPL_USER'/g\&quot; $destdir/recovery.conf&quot;

psql -c &quot;SELECT pg_stop_backup()&quot; postgres
</code></pre>

<p>pgpool_remote_start</p>

<pre><code class="language-sh">#!/usr/bin/env bash
# start postmaster on the recoveried node

if [ $# -ne 2 ]
then
    echo &quot;pgpool_remote_start remote_host remote_datadir&quot;
    exit 1
fi

SCRIPT_LOG=&quot;/var/log/pgpool/remote_start.log&quot;

DEST_HOST=$1

echo &quot;----------------------------------------------------------------------&quot; &gt;&gt; ${SCRIPT_LOG}
date &gt;&gt; ${SCRIPT_LOG}
echo &quot;----------------------------------------------------------------------&quot; &gt;&gt; ${SCRIPT_LOG}
echo &quot;&quot; &gt;&gt; ${SCRIPT_LOG}

COMMAND=&quot;pg_ctl -w  start &gt; /dev/null 2&gt;&amp;1&quot;

echo &quot;
DEST_HOST         ${DEST_HOST}
COMMAND           ${COMMAND}
&quot; &gt;&gt; ${SCRIPT_LOG}

echo &quot;remote start&quot; &gt;&gt; ${SCRIPT_LOG}
ssh postgres@${DEST_HOST} -T &quot;${COMMAND}&quot;

ps auwx | grep postgres &gt;&gt; ${SCRIPT_LOG}
echo &quot;&quot; &gt;&gt; ${SCRIPT_LOG}
</code></pre>

<h2 id="四-配置db1">四.配置db1</h2>

<p>初始化并启动</p>

<pre><code class="language-sh">root@ubuntu~# su - postgres
postgres@ubuntu:~$ initdb -U postgres
</code></pre>

<p>修改postgresql.conf配置文件</p>

<pre><code class="language-ini">log_destination = 'csvlog' # 使用csv格式的log,因为一般会按大小和时间自动切割
logging_collector = on # 如果使用csvlog，那么要开启日志收集
listen_addresses = '*'
wal_level = hot_standby # 日志级别使用hot_standby
archive_mode = on
archive_command = 'cp %p /home/postgres/db/archive/%f'
max_wal_senders = 3
</code></pre>

<p>启动pg，添加pgpool_recovery扩展</p>

<pre><code class="language-sh">postgres@ubuntu:~$ pg_ctl start &gt; /dev/null 2&gt;&amp;1
postgres@ubuntu:~$ psql template1 -c 'create extension pgpool_recovery;'
</code></pre>

<p>创建用于备份的用户</p>

<pre><code class="language-sh">postgres@ubuntu:~$ createuser rep -l --replication -E -P
</code></pre>

<p>修改pg_hba.conf，加入</p>

<pre><code>host  all      rep      10.0.0.0/24    trust
host  all      postgres 10.0.0.0/24    trust
</code></pre>

<h2 id="五-配置db2">五.配置db2</h2>

<p>通过pg_basebackup和db1同步</p>

<pre><code class="language-sh">postgres@ubuntu:~$ pg_basebackup -D /home/postgres/db/data -Fp -Xs -v -P -h db1 -U rep
</code></pre>

<p>从/home/postgres/db/share下拷贝recovery.conf文件到data目录下，并修改</p>

<pre><code class="language-ini">standby_mode = on
primary_conninfo = 'host=db1 port=5432 user=rep'
</code></pre>

<p>修改postgresql.conf配置：</p>

<pre><code class="language-ini">hot_standby = on # 开启热备模式
</code></pre>

<p>启动pg</p>

<pre><code class="language-sh">postgres@ubuntu:~$ pg_ctl start &gt; /dev/null 2&gt;&amp;1
</code></pre>

<h2 id="六-配置pgpool">六.配置pgpool</h2>

<p>修改db1上pgpool.conf：</p>

<pre><code class="language-ini">listen_addresses = '*'
pcp_listen_addresses = '*'
enable_pool_hba = on
pool_passwd = 'pool_passwd'
replication_mode = off # 关闭复制模式
load_balance_mode = on # 打开负载均衡
master_slave_mode = on # 打开主备
log_destination = 'syslog' # 日志使用syslog
master_slave_sub_mode='stream' # 使用流复制
sr_check_user = 'rep'
sr_check_password = 'rep' # 创建rep用户的时候指定
health_check_user = 'rep'
health_check_password = 'rep'
failover_command = '/home/postgres/db/failover_stream.sh %d %h %p %D %m %M %H %P %r %R'
backend_hostname0 = 'db1'
backend_port0 = 5432
backend_weight0 = 1
backend_data_directory0 = '/home/postgres/db/data'
backend_flag0 = 'ALLOW_TO_FAILOVER'
backend_hostname1 = 'db2'
backend_port1 = 5432
backend_weight1 = 1
backend_data_directory1 = '/home/postgres/db/data'
backend_flag1 = 'ALLOW_TO_FAILOVER'
use_watchdog = on # 开启watchdog
wd_hostname = 'db1'
delegate_IP = '10.0.0.4'
heartbeat_destination0 = 'db2'
other_pgpool_hostname0 = 'db2'
other_pgpool_port0 = 9999
other_wd_port0 = 9000
recovery_user = 'postgres'
recovery_password = ''
recovery_1st_stage_command = 'basebackup.sh'
</code></pre>

<p>修改db2上pgpool.conf（和db1中有区别的）:</p>

<pre><code class="language-ini">wd_hostname = 'db2'
heartbeat_destination0 = 'db1'
other_pgpool_hostname0 = 'db1'
</code></pre>

<p>db1和db2上的pool_hba.conf中添加</p>

<pre><code class="language-ini">host all postgres 10.0.0.0/24 trust
</code></pre>

<p>db1和db2上的/etc/rsyslog.conf添加，并重启rsyslog</p>

<pre><code class="language-ini">local0.*    /var/log/pgpool.log
</code></pre>

<p>使用pg_md5生成密钥，db1和db2上的密钥可能不同:</p>

<pre><code class="language-sh">postgres@ubuntu:~$ pg_md5 postgres
21232f297a57a5a743894a0e4a801fc3

# 在pcp.conf中添加postgres:21232f297a57a5a743894a0e4a801fc3
</code></pre>

<p>在db1和db2上启动pgpool</p>

<pre><code class="language-sh">postgres@ubuntu:~$ pgpool
</code></pre>

<p>至此，安装完成，下面进行简单的测试。</p>

<h2 id="七-测试">七.测试</h2>

<pre><code class="language-sh"># 使用VIP登录pg，发现db1主，db2备
postgres@ubuntu:~$ psql -h 10.0.0.4 -p 9999
psql (9.4.0)
Type &quot;help&quot; for help.

postgres=# show pool_nodes;
 node_id | hostname | port | status | lb_weight |  role
---------+----------+------+--------+-----------+---------
 0       | db1      | 5432 | 2      | 0.500000  | primary
 1       | db2      | 5432 | 2      | 0.500000  | standby
(2 rows)

# 关闭db1上的pg服务，再次查看nodes，故障切换完成，db1变成备，db2变成主

postgres=# show pool_nodes;
 node_id | hostname | port | status | lb_weight |  role
---------+----------+------+--------+-----------+---------
 0       | db1      | 5432 | 3      | 0.500000  | standby
 1       | db2      | 5432 | 2      | 0.500000  | primary
(2 rows)

# 恢复db1，注意要进行恢复操作，必须使用主节点上的pgpool服务
# 这里db2目前是主节点，所以pgpool的hostname使用db2
postgres@ubuntu:~$ pcp_recovery_node -d 5 db2 9898 postgres postgres 0

postgres=# show pool_nodes;
 node_id | hostname | port | status | lb_weight |  role
---------+----------+------+--------+-----------+---------
 0       | db1      | 5432 | 2      | 0.500000  | standby
 1       | db2      | 5432 | 2      | 0.500000  | primary
(2 rows)
</code></pre>

<p>其中status的值如下：</p>

<p>0：从未使用，直接忽略</p>

<p>1：server已经启动，但是连接池中没有连接</p>

<p>2：server已经启动，并且在连接池中存在连接</p>

<p>3：server没有启动或者联系不上</p>
		</div>
		

	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Sung Yung avatar" src="/img/sy.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Sung Yung</span>
	</div>
	<div class="authorbox__description">
		一枚Pythoner，热爱编程，喜欢新东西（当然女朋友不用）。
	</div>
</div>
	
<nav class="post-nav row clearfix" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/post/python-routes/" rel="prev"><span class="post-nav__caption">«Previous</span><p class="post-nav__post-title">Python routes</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/post/c-args/" rel="next"><span class="post-nav__caption">Next»</span><p class="post-nav__post-title">C语言可变参数</p></a>
	</div>
</nav>

	
</div>

<aside class="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="//google.com/search">
		<label>
			<span class="screen-reader-text">Search for:</span>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="/" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/python-property/">Python Week 0001 --- property</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/swift-tempurl/">Openstack Swift tempurl 和 largeobject 支持</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/python-howto-descriptor/">Pythons HOWTO之属性描述符</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/python-decorate/">Python装饰器的几种类型</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/python-bibao/">Python闭包的作用域理解</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/python-twisted01/">Twisted源码分析系列01-reactor</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/python-with/">浅谈Python的with语句(转载)</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/python-future/">Python __future__ 模块</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/pass/">PaaS以及开源PaaS平台</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/cloudfoundry/">深入CloudFoundry一周年（转载）</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/python">Python</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/python-everyweek">Python-Everyweek</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/%e4%ba%91%e8%ae%a1%e7%ae%97">云计算</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/%e5%85%b6%e4%bb%96">其他</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget__link widget__link--taglist" href="/tags/python" title="python">python</a>
	</div>
</div>
</aside>
	</div>
		<footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
			<div class="container container-inner">
				<p class="footer__copyright">&copy; 2017 Sung Yung. Based on <a href="//wordpress.org/themes/mh-magazine-lite/" target="_blank" rel="nofollow noopener noreferrer">MH Magazine lite</a>.</p>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>

</body>
</html>